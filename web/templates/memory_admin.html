<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Admin - Chat Bot</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 2rem;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #f1f8ff;
            font-weight: bold;
        }
        .conversation-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .conversation-item:hover {
            background-color: #f8f9fa;
        }
        .conversation-item:last-child {
            border-bottom: none;
        }
        .conversation-name {
            flex-grow: 1;
            font-weight: 500;
        }
        .memory-count {
            color: #6c757d;
            font-size: 0.85rem;
            margin-right: 1rem;
        }
        .context-count {
            color: #6c757d;
            font-size: 0.85rem;
            white-space: nowrap;
            margin-right: 1rem;
        }
        .last-active {
            color: #6c757d;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .connection-status {
            padding: 0.5rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
        }
        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .memory-detail {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .memory-content {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        .memory-metadata {
            display: flex;
            font-size: 0.8rem;
            color: #6c757d;
        }
        .memory-metadata span {
            margin-right: 1rem;
        }
        .context-messages {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        .context-message {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px dashed #dee2e6;
        }
        .context-message:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        .edit-memory-modal textarea {
            width: 100%;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <h1 class="mb-4">Memory Admin Panel</h1>
                
                <!-- Connection Status -->
                <div id="connection-status" class="connection-status">
                    Checking connection status...
                </div>
                
                <!-- Memories Overview Card -->
                <div class="card">
                    <div class="card-header">
                        Conversation Memories
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            Select a conversation to view and manage its memories and context.
                        </p>
                        
                        <div id="conversations-container">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading conversations...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Memory Details Card -->
                <div id="memory-details-card" class="card d-none">
                    <div class="card-header">
                        <span id="selected-conversation-name">Conversation Details</span>
                        <button id="back-to-list" class="btn btn-sm btn-outline-secondary float-end">Back to List</button>
                    </div>
                    <div class="card-body">
                        <!-- Memories Section -->
                        <h5 class="card-title">Memories</h5>
                        <div id="memories-container">
                            <p>No memories found for this conversation.</p>
                        </div>
                        
                        <button id="clear-all-memories" class="btn btn-danger mt-3">Clear All Memories</button>
                        
                        <!-- Context Section -->
                        <h5 class="card-title mt-4">Context Messages</h5>
                        <div id="context-container" class="context-messages">
                            <p>No context messages found for this conversation.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Information Card -->
                <div class="card">
                    <div class="card-header">
                        Information
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">Memory System</h5>
                        <p class="card-text">
                            The memory system automatically extracts and stores important information from conversations.
                            This information is used to personalize responses and provide context for future interactions.
                        </p>
                        
                        <h5 class="card-title mt-3">WhatsApp Integration</h5>
                        <p class="card-text">
                            Memories are stored for each WhatsApp conversation, helping the bot remember important details
                            and provide more contextual responses.
                        </p>
                        
                        <a href="/admin/whatsapp" class="btn btn-outline-primary mt-3">WhatsApp Admin</a>
                        <a href="/" class="btn btn-secondary mt-3">Back to Main Page</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Memory Modal -->
    <div class="modal fade" id="edit-memory-modal" tabindex="-1" aria-labelledby="edit-memory-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="edit-memory-modal-label">Edit Memory</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-memory-id" value="">
                    <div class="mb-3">
                        <label for="edit-memory-content" class="form-label">Memory Content</label>
                        <textarea id="edit-memory-content" class="form-control"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-memory-edit">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentConversationId = null;
        let editMemoryIndex = -1;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check WhatsApp connection status
            checkStatus();
            
            // Load conversations with memories
            loadConversations();
            
            // Set up back button
            document.getElementById('back-to-list').addEventListener('click', showConversationsList);
            
            // Set up clear all memories button
            document.getElementById('clear-all-memories').addEventListener('click', clearAllMemories);
            
            // Set up save memory edit button
            document.getElementById('save-memory-edit').addEventListener('click', saveMemoryEdit);
        });
        
        // Check WhatsApp connection status
        function checkStatus() {
            fetch('/api/whatsapp/status')
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('connection-status');
                    
                    if (data.connected) {
                        statusElement.innerHTML = '<strong>Status:</strong> Connected to WhatsApp';
                        statusElement.className = 'connection-status status-connected';
                    } else {
                        statusElement.innerHTML = '<strong>Status:</strong> Disconnected from WhatsApp';
                        statusElement.className = 'connection-status status-disconnected';
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    document.getElementById('connection-status').innerHTML = 
                        '<strong>Status:</strong> Error checking connection status';
                    document.getElementById('connection-status').className = 
                        'connection-status status-disconnected';
                });
        }
        
        // Load conversations with memories
        function loadConversations() {
            fetch('/api/whatsapp/memory/all')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('conversations-container');
                    
                    if (data.length === 0) {
                        container.innerHTML = '<p>No conversations with memories found.</p>';
                        return;
                    }
                    
                    let html = '';
                    data.forEach(conversation => {
                        const lastActive = new Date(conversation.last_activity).toLocaleString();
                        
                        html += `
                            <div class="conversation-item" data-id="${conversation.conversation_id}" onclick="loadConversationDetails('${conversation.conversation_id}')">
                                <div class="conversation-name">${conversation.group_name || 'Unnamed Group'}</div>
                                <div class="memory-count">${conversation.memory_count} memories</div>
                                <div class="context-count">${conversation.context_count} context msgs</div>
                                <div class="last-active">Last active: ${lastActive}</div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading conversations:', error);
                    document.getElementById('conversations-container').innerHTML = 
                        '<p>Error loading conversations. Please try again later.</p>';
                });
        }
        
        // Load conversation details
        function loadConversationDetails(conversationId) {
            currentConversationId = conversationId;
            
            fetch(`/api/whatsapp/memory/conversation?id=${conversationId}`)
                .then(response => response.json())
                .then(data => {
                    // Update conversation name
                    document.getElementById('selected-conversation-name').textContent = 
                        data.group_name || 'Unnamed Group';
                    
                    // Update memories
                    const memoriesContainer = document.getElementById('memories-container');
                    if (data.memories.length === 0) {
                        memoriesContainer.innerHTML = '<p>No memories found for this conversation.</p>';
                    } else {
                        let html = '';
                        data.memories.forEach((memory, index) => {
                            const createdAt = new Date(memory.created_at).toLocaleString();
                            const lastUsed = new Date(memory.last_used).toLocaleString();
                            
                            html += `
                                <div class="memory-detail">
                                    <div class="memory-content">${memory.content}</div>
                                    <div class="memory-metadata">
                                        <span>Created: ${createdAt}</span>
                                        <span>Last used: ${lastUsed}</span>
                                        <span>Used ${memory.use_count} times</span>
                                    </div>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editMemory(${index}, '${memory.content}')">Edit</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMemory(${index})">Delete</button>
                                    </div>
                                </div>
                            `;
                        });
                        memoriesContainer.innerHTML = html;
                    }
                    
                    // Update context
                    const contextContainer = document.getElementById('context-container');
                    if (data.context.length === 0) {
                        contextContainer.innerHTML = '<p>No context messages found for this conversation.</p>';
                    } else {
                        let html = '';
                        data.context.forEach(message => {
                            html += `<div class="context-message">${message}</div>`;
                        });
                        contextContainer.innerHTML = html;
                    }
                    
                    // Show details card, hide list
                    document.getElementById('memory-details-card').classList.remove('d-none');
                    document.querySelector('.card:first-of-type').classList.add('d-none');
                })
                .catch(error => {
                    console.error('Error loading conversation details:', error);
                    alert('Error loading conversation details. Please try again.');
                });
        }
        
        // Show conversations list, hide details
        function showConversationsList() {
            document.getElementById('memory-details-card').classList.add('d-none');
            document.querySelector('.card:first-of-type').classList.remove('d-none');
            currentConversationId = null;
        }
        
        // Edit memory
        function editMemory(index, content) {
            editMemoryIndex = index;
            document.getElementById('edit-memory-content').value = content;
            
            const modal = new bootstrap.Modal(document.getElementById('edit-memory-modal'));
            modal.show();
        }
        
        // Save memory edit
        function saveMemoryEdit() {
            const content = document.getElementById('edit-memory-content').value.trim();
            
            if (!content) {
                alert('Memory content cannot be empty');
                return;
            }
            
            fetch('/api/whatsapp/memory/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    conversation_id: currentConversationId,
                    memory_index: editMemoryIndex,
                    content: content
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        bootstrap.Modal.getInstance(document.getElementById('edit-memory-modal')).hide();
                        loadConversationDetails(currentConversationId);
                    } else if (data.error) {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error updating memory:', error);
                    alert('Error updating memory. Please try again.');
                });
        }
        
        // Delete memory
        function deleteMemory(index) {
            if (!confirm('Are you sure you want to delete this memory?')) {
                return;
            }
            
            fetch('/api/whatsapp/memory/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    conversation_id: currentConversationId,
                    memory_index: index
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        loadConversationDetails(currentConversationId);
                    } else if (data.error) {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting memory:', error);
                    alert('Error deleting memory. Please try again.');
                });
        }
        
        // Clear all memories
        function clearAllMemories() {
            if (!confirm('Are you sure you want to clear ALL memories for this conversation? This cannot be undone.')) {
                return;
            }
            
            fetch('/api/whatsapp/memory/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    conversation_id: currentConversationId
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        // Go back to list after clearing
                        showConversationsList();
                        // Refresh the list
                        loadConversations();
                    } else if (data.error) {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error clearing memories:', error);
                    alert('Error clearing memories. Please try again.');
                });
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
